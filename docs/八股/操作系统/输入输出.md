# 概述

## I/O设备分类

1. 与人进行交互
   * 用于和用户进行通信
   * 打印机
   * 视频显示设备 
     * 显示器 
     * 键盘 
     * 鼠标 

2. 与设备进行交互用于和电子设备进行通信
   * 磁盘和磁带
   * 传感器
   * 控制器
   * 传动器

所有设备在操作系统中被粗略地分为两类

1. 按照信息交换的单位：

   * 块设备：以块为单位进行数据传输（可块寻址）

     * 传输快

     * eg：磁盘

   * 字符设备：以字符为单位进行数据传输 

     * 传输慢
     * 不可寻址，常采用中断驱动方式

     * eg: 鼠标、键盘


2. 网络设备：网卡、网桥、集线器、路由器、网关… 

* 更多：时钟设备、内存映射的显示器

## I/O设备的不同

1. 数据传输率

   * 不同设备在数据传输率上有可能相差几个数量级

2. 应用

   如

   * 当磁盘用于存储文件时需要文件管理软件的配合
   * 当磁盘用于存储虚页时需要特殊的硬件和软件的支持
   * 被系统管理员使用的终端必须具有高级的优先权

3. 控制的复杂度

4. 传输单位

   * 对于终端,数据的传输是以字符流为单位,而 磁盘则是以块为单位

5. 数据的表示方式

   * 不同设备编码方式不一样

6. 出错表示方式

##  I/O设备的组成

* 机械部分
* 电子部分

>  组成设备的电子部分就是设备控制器（一个设备控制器可以处理一类设备）

控制器的任务：

* 将串行的位流转换成字节块
* 尽可能进行纠错
* 可以与主存进行读写操作

## I/O接口基本电路

左边为CPU

![image-20241216193305181](https://typora5672.oss-cn-chengdu.aliyuncs.com/temp/image-20241216193305181.png)

## I/O编址

![image-20241216193513598](https://typora5672.oss-cn-chengdu.aliyuncs.com/temp/image-20241216193513598.png)

(a)单独的I/O和内存空间

(b) 内存映射I/O

* 控制器中的寄存器与内存地址统一编址。

(c) 混合方案

## I/O数据传输方式

1. 程序控制I/O
   * 在进行输入/输出时，CPU处于一种忙等待
2. 中断驱动I/O
   * CPU发出I/O命令，由控制器具体执行
   * CPU转去执行其他指令
3. 控制器完成I/O后，向CPU发中断信号直接存储器存取 (DMA(Direct Memory Access))
   * 由专门的DMA控制器控制数据在内存与外部设备间的传输
   * CPU仅仅在所有数据传输结束后进行中断干预
   * DMA传送操作
   * ![image-20241216202735224](https://typora5672.oss-cn-chengdu.aliyuncs.com/temp/image-20241216202735224.png)
4. 通道控制方式

# I/O数据传输方式

## 程序控制I/O

> 在进行输入/输出时，CPU处于一种忙等待（轮询）

#### 打印一个字符串的步骤

![image-20241216203232686](https://typora5672.oss-cn-chengdu.aliyuncs.com/temp/image-20241216203232686.png)

使用程序控制I/O将一个字符串写到打印机

```c
copy_from_user(buffer,p,count); //p：内核空间缓存
for(int i=0;i<count;i++){
    while(*printer_status_reg!=READY); //忙等待循环，等待打印机的状态寄存器变为READY
    *printer_data_register = p[i]; //输出一个字符
}
return_to_user();
```

## 中断驱动I/O

> 1. 方式：
>
>    * CPU发出I/O命令，由控制器具体执行
>
>    * CPU转去执行其他指令，知道CPU收到控制器中断信号。
>
> 2. 优点：
>
>    * CPU和IO可并行工作CPU利用率明显提升
>
> 3. 缺点:
>
>    * 中断处理会消耗大量CPU时间

## DMA(直接存储器存取)

> 1. 方式：
>    * 控制器完成I/O后，向CPU发中断信号直接存储器存取
> 2. 说明:
>    * 由专门的DMA控制器控制数据在内存与外部设备间的传输
>    * CPU仅仅在所有数据传输结束后进行中断干预
>    * 数据传输方式为“块”，不再是前两种方式的“字”

DMA传送操作:![image-20241228155546443](https://typora5672.oss-cn-chengdu.aliyuncs.com/temp/image-20241228155546443.png)

## 通道控制方式

![image-20241228160215180](https://typora5672.oss-cn-chengdu.aliyuncs.com/temp/image-20241228160215180.png)

# I/O 软件

## I/O软件的目标

1. 设备独立性
   * 程序能够访问任意的设备
   * 不需要事先指定(如读取硬盘, 软盘, 或光驱)
2. 统一命名
   * 一个文件或设备的名字应该是一个简单的字符串或一个整数
   * 不应依赖于任何设备
3. 错误处理
   * 错误应该尽可能在接近硬件层面得到处理

4. 同步(Synchronous)和异步( asynchronous) 传输
   * 阻塞式传输和中断驱动传输
5. 缓冲
   * 数据离开一个设备后通常并不能直接存放到目的地
6. 共享设备和独占设备
   * 磁盘是共享设备
   * 磁带是独占性设备

## I/O 软件层次

![image-20241228170743584](https://typora5672.oss-cn-chengdu.aliyuncs.com/temp/image-20241228170743584.png)

I/O系统的层次以及每一层的主要功能:

![image-20241228172914263](https://typora5672.oss-cn-chengdu.aliyuncs.com/temp/image-20241228172914263.png)

![image-20241228172927625](https://typora5672.oss-cn-chengdu.aliyuncs.com/temp/image-20241228172927625.png)

### 中断处理程序

* 中断向量程序应该隐藏在操作系统内部
  * 将启动I/O操作的驱动程序阻塞起来,直到I/O操 作完成且产生一个中断

* 中断处理程序将完成它所要做的全部工作
  * 然后将启动中断的驱动程序解除阻塞

* 硬件中断完成之后软件中断的执行步骤
  1. 保存没有被中断硬件保存的所有寄存器
  2. 为中断服务过程设置上下文,可能包括设置 TLB,MMU和页表
  3. 为中断服务过程设置堆栈
  4. 应答中断控制器,如果不存在集中的中断控制器, 则再次开放中断
  5. 将寄存器从它们被保存的地方复制到进程表中
  6. 运行中断服务过程,从发出中断的设备控制器的 寄存器中提取信息
  7. 选择下一次运行哪一个进程
  8. 为下一次要运行的进程设置MMU上下文
  9. 装入新进程的寄存器
  10. 开始运行新进程

### 设备驱动程序

>  概念：驱动物理设备和ＤＭＡ／Ｉ／Ｏ控制器等直接进 行Ｉ／Ｏ操作的子程序的集合，它是低级的系统例程,   使用特权指令访问硬件，在系统初始化时启动（常由汇编或系统编程语言写成）

处理过程： 

* 将抽象要求转换为具体要求 
* 检查Ｉ／Ｏ请求的合法性
* 读出和检查设备状态 
* 传送必要参数 
* 方式设置 
* 启动Ｉ／Ｏ设备

![image-20241229110030578](https://typora5672.oss-cn-chengdu.aliyuncs.com/temp/image-20241229110030578.png)

### 与设备无关的I/O软件

![image-20241229110306450](https://typora5672.oss-cn-chengdu.aliyuncs.com/temp/image-20241229110306450.png)

#### 缓冲区管理

![image-20241229110420035](https://typora5672.oss-cn-chengdu.aliyuncs.com/temp/image-20241229110420035.png)

##### 双缓冲

> * 使用两个系统内核空间中的缓冲
> * 当第一个缓冲区被填满之后,在它被清空之前 可以使用第二个缓冲区

![image-20241229110516573](https://typora5672.oss-cn-chengdu.aliyuncs.com/temp/image-20241229110516573.png)

##### 循环缓冲

> * 可以使用的缓冲区有两个以上
> * Each individual buffer is one unit in a circular  buffer
> * Used when I/O operation must keep up with  process

![image-20241229110616438](https://typora5672.oss-cn-chengdu.aliyuncs.com/temp/image-20241229110616438.png)

##### 缓冲池

> * 这是一种双方向缓冲技术；缓冲区整体利用率高。
> * 缓冲区队列：三种：空闲缓冲区，输入缓冲区，输 出缓冲区
> * 操作：四种：设备输入，CPU读入，设备输出， CPU写出。上述操作访问各个缓冲区队列时，需要 进行相应的互斥操作。

![image-20241229110738268](https://typora5672.oss-cn-chengdu.aliyuncs.com/temp/image-20241229110738268.png)

# SPOOLing(假脱机,虚拟设备技术)

> 引入：在多道批处理系统中，专门利用一道程序（SPOOLing 程序）来完成对设备的I/O操作。无需使用外围I/O处理机。

![image-20241228173551098](https://typora5672.oss-cn-chengdu.aliyuncs.com/temp/image-20241228173551098.png)

可把独享设备转变成具有共享特征的虚拟设备，从而提高设备利用率。

![image-20241228173651119](https://typora5672.oss-cn-chengdu.aliyuncs.com/temp/image-20241228173651119.png)

# 盘

## 盘的硬件

![image-20241229111215505](https://typora5672.oss-cn-chengdu.aliyuncs.com/temp/image-20241229111215505.png)

![image-20241229111345116](https://typora5672.oss-cn-chengdu.aliyuncs.com/temp/image-20241229111345116.png)

## 磁头臂调度

> * 读写一个磁盘块的时间由下面三个时间因素构成:
>   1. 寻道时间
>   2. 旋转延迟
>   3. 实际数据传输时间
>
> * 寻道时间占主导地位
> * 传输过程中的纠错由控制器完成

### 磁头臂调度策略

#### 先来先服务(FCFS/FIFO)

> * 按达到顺序满足进程的需求
> * 对所有进程都公平
> * 在磁盘I/O负载较轻且每次读写多个连续扇区时， 性能较好

![image-20241229112851351](https://typora5672.oss-cn-chengdu.aliyuncs.com/temp/image-20241229112851351.png)

#### 最短寻道时间优先(SSTF)

> 考虑磁盘I/O请求队列中各请求的磁头定位位置，选 择从当前磁头位置出发，移动最少的磁盘I/O请求

* 该算法的目标是使每次磁头移动时间最少。它不一 定是最短平均柱面定位时间，但比FIFO算法有更好的性能。
* 对中间的磁道有利，可能会有进程处于饥饿状态。

![image-20241229113149868](https://typora5672.oss-cn-chengdu.aliyuncs.com/temp/image-20241229113149868.png)

![image-20241229113413074](https://typora5672.oss-cn-chengdu.aliyuncs.com/temp/image-20241229113413074.png)

#### SCAN(elevator algorithm,扫描算法,电梯算法)

> * 选择在磁头前进方向上从当前位置移动最少的磁 盘I/O请求执行，没有前进方向上的请求时才改变方向。
> * 该算法是对SSTF算法的改进，磁盘I/O较好，且 没有进程会饿死。

![image-20241229114235270](https://typora5672.oss-cn-chengdu.aliyuncs.com/temp/image-20241229114235270.png)

#### C-SCAN(循环扫描)

> * 严格按照一个方向进行扫描,在一个方向上使用 扫描算法，当到达边沿时直接移动到另一沿的第 一个位置。
> * 该算法可改进扫描算法对中间磁道的偏好。实验表明，该算法在中负载或重负载时，磁盘I/O性能比扫描算法好。

上例中扫描完36，直接转去扫描1，再扫描9

#### 优先级

* 目标是系统目标的实现，而不是改进磁盘I/O性 能
* 短作业具有较高优先级
* 反映进程在系统的优先级特征,具有较好系统交 互响应时间

#### 后进先出

* 该算法是基于事务系统中顺序文件中磁盘I/O的局部性特征，相邻访问的位置也相邻。
* 它的问题在于系统负载重时，可能有进程的磁盘I/O 永远不能执行，处于饥饿状态。

### 减少旋转延迟的方法

1. 交替编号
   * 做法：让编号相邻的扇区在物理上不相邻
   * 原理：读完一个删除，需要一段时间处理才可以读下一个扇区
   * ![image-20241229115700211](https://typora5672.oss-cn-chengdu.aliyuncs.com/temp/image-20241229115700211.png)

2. 柱面斜进(错位命名)

   * 做法：让相邻盘面的扇区编号“错位”

   ![image-20241229115933218](https://typora5672.oss-cn-chengdu.aliyuncs.com/temp/image-20241229115933218.png)