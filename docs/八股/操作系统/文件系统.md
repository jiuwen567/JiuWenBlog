# 文件

## 文件逻辑结构

![image-20241223170212199](https://typora5672.oss-cn-chengdu.aliyuncs.com/temp/image-20241223170212199.png)

三种文件结构：

*  字节序列
* 记录序列
* 树

## 文件类型

普通文件

* ASCII文件、二进制文件

目录文件

特殊文件

* 字符、块

## 文件存取

顺序存取

随机存取

# 目录

## 一级目录系统

![image-20241226110018952](https://typora5672.oss-cn-chengdu.aliyuncs.com/temp/image-20241226110018952.png)

## 两层目录系统

![image-20241226110032944](https://typora5672.oss-cn-chengdu.aliyuncs.com/temp/image-20241226110032944.png)

## 层次目录系统

![image-20241226110053988](https://typora5672.oss-cn-chengdu.aliyuncs.com/temp/image-20241226110053988.png)

# 文件系统的实现

## 文件的实现

### 连续结构

![image-20241226110742873](https://typora5672.oss-cn-chengdu.aliyuncs.com/temp/image-20241226110742873.png)

### 链表结构

![image-20241226110801601](https://typora5672.oss-cn-chengdu.aliyuncs.com/temp/image-20241226110801601.png)

在内存中的链表结构：![image-20241226110916593](https://typora5672.oss-cn-chengdu.aliyuncs.com/temp/image-20241226110916593.png)

### 索引结点结构

![image-20241226110956407](https://typora5672.oss-cn-chengdu.aliyuncs.com/temp/image-20241226110956407.png)

#### 多级索引的物理结构

![image-20241226111102590](https://typora5672.oss-cn-chengdu.aliyuncs.com/temp/image-20241226111102590.png)

![image-20241226111317226](https://typora5672.oss-cn-chengdu.aliyuncs.com/temp/image-20241226111317226.png)

> 二次间接索引，第一个索引表中的索引块存储的是指向其他索引块的地址

### 文件系统的几种物理结构分析

![image-20241226111752250](https://typora5672.oss-cn-chengdu.aliyuncs.com/temp/image-20241226111752250.png)

## 目录的实现

![image-20241226111930986](https://typora5672.oss-cn-chengdu.aliyuncs.com/temp/image-20241226111930986.png)

(a) 简单目录实现：将文件名与文件属性作为一个目录项 放在一起。即包含固定大小的目录项，在目录项中有 磁盘地址和属性。

(b) 索引目录实现：将文件名与文件属性分开，每个目录项只有文件名和索引节点。

### 目录实现的问题

1. 可变长文件名问题 
2. 文件共享问题
   * 有共享文件的文件系统![image-20241226112641408](https://typora5672.oss-cn-chengdu.aliyuncs.com/temp/image-20241226112641408.png)



### 在目录中处理长文件名的两种方法

![image-20241226112244100](https://typora5672.oss-cn-chengdu.aliyuncs.com/temp/image-20241226112244100.png)

 (a) 在行中

 (b) 在堆中

### 共享文件

#### 硬链接（共享索引节点）

![image-20241226112849394](https://typora5672.oss-cn-chengdu.aliyuncs.com/temp/image-20241226112849394.png)

(a) 连接之前的状况

(b) 创建连接之后

 (c) 当所有者删除文件后

#### 软链接（符号链接）

1. 系统为共享文件在共享目录下建立新的文件（类型LINK）
2. 新建立LINK文件内容为共享文件的链接， 即共享文件路径名 
3. 访问共享文件时，先找到该LINK文件，根 据其中的链接访问该文件
4. eg:桌面快捷方式

## 文件系统的可靠性

### 文件系统备份

备份原因:

* 灾备
* 数据丢失

备份策略：(全量, 增量)

转储：

* 物理转储
* 逻辑转储

### 文件系统一致性

![image-20241226115417846](https://typora5672.oss-cn-chengdu.aliyuncs.com/temp/image-20241226115417846.png)

文件系统状态：

* 一致（a）
* 块丢失 (b)
* 空闲表中有重复块 （c）
* 重复数据块 (d)

## 文件系统性能

1. 高速缓存

2. 块提前读
   * 若当前访问块k，提前预读k+1块
   * 仅仅适用于顺序读取的文件

3. 减少磁盘臂运动
   * 可能顺序存取的块放在一起（位图，块簇）
   * i节点分散存放
   * ![image-20241226120125404](https://typora5672.oss-cn-chengdu.aliyuncs.com/temp/image-20241226120125404.png)

### 磁盘碎片整理

* 操作系统初始安装后，从磁盘的开始位 置连续安装了程序与文件。
* 随着文件被不断创建与删除，磁盘空间 会产生很多碎片，影响性能。
* 磁盘性能的恢复方法：移动文件使他们相邻，并把所有的空闲空间放在一个或 多个大的连续区域内。

## 文件操作

1. Create 2. Delete 3. Open 4. Close 5. Read 6. Write 7. Append 8. Seek 9. Get attributes 10.Set Attributes 11.Rename

## 思考题

1. 文件的定义
2. **文件类型**
   * [文件类型](#文件类型)
3. 文件系统的功能
4. 文件系统的结构
5. 文件的逻辑结构和物理结构
6. **Unix 的多级索引结构**
   * [多级索引的物理结构](#多级索引的物理结构)
7. **文件存储空间的管理（空闲块管理）**
8. 文件目录和检索
9. 文件控制块和目录文件
10. 文件保护：存取控制表和用户权限表
11. 打开文件：系统打开文件表、用户打开文件表、文件描述字fd 
12. 改善文件系统性能的三种方法
    * [文件系统性能](#文件系统性能)
13. ![image-20250107133048661](https://typora5672.oss-cn-chengdu.aliyuncs.com/temp/image-20250107133048661.png)
    * D*F<B(位图的空间需求B位)
    * 16*F<B–>F/B<1/16

## 思考题 2

1. 影响系统缺页率的因素有哪些？
   * 页面置换算法的选择、工作集模型的大小与变化速度、页面大小的设定、程序本身的特性和大小、分配给程序的物理页面数、内存访问模式、系统负载情况、预取和缓存机制的有效性以及多道程序设计中的策略。这些因素相互作用，共同决定了程序在运行过程中发生缺页中断的频率。
2. 文件的逻辑结构有哪两种？
   * 序列(字节序列、记录序列)、树。
3. 文件的存取方式分别是哪些？
   * 顺序存取、随机存取
4. 文件的连续结构、索引结构和串联结构，分别适合怎样的文件存取方式？
   * 连续结构适合顺序存取和随机存取。索引结构适合顺序和随机存取。串联结构适合顺序存取。
   * [文件系统的几种物理结构分析](#文件系统的几种物理结构分析)
5. 我们对一个文件进行访问前，通常首先要调用open函数，你认为这个open函数本质上应该完成怎样的操作？
   * 调用open函数的本质操作是，首先验证文件路径的合法性以及调用进程的访问权限，然后为打开的文件在操作系统层面分配一个文件描述符，并根据指定的模式设置文件的状态标志，接着在操作系统的文件表中为该文件创建一个表项以记录其元数据，同时将文件指针定位到适当的位置，最后返回文件描述符或句柄供后续操作使用，如果在过程中遇到错误，则返回错误指示并设置错误信息。
6. 文件的两种目录组织结构分别是？分析不同目录组织结构的特点。
   * 平面文件目录结构和层次化文件目录结构。平面文件目录结构简单，所有文件存放在同一目录下，但随着文件数量增加，管理变得困难，且文件访问效率低下。而层次化文件目录结构将文件和目录组织成树状结构，具有结构化、命名空间划分、访问效率高、可扩展性强和安全性高等特点，更适用于文件数量较多的情况，因此成为现代操作系统中的主流组织方式。
7. 实现文件共享的方式有哪些？
   * 硬链接（共享索引节点）和软链接（符号链接）。
8. 如何保证文件的可靠性
   * 1）文件备份：全量、增量；块拷贝、逻辑备份。2）文件的一致性：块一致性、文件一致性。
