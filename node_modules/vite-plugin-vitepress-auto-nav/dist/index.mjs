import{normalize as t,sep as e,join as i,resolve as n}from"path";import{utimesSync as o,existsSync as s}from"fs";import{readFile as r,stat as m,mkdir as a,writeFile as c}from"fs/promises";import l from"fast-glob";import f from"gray-matter";import{spawn as d}from"child_process";async function p(t,e){const i=C[t];if(i){if((await m(t)).mtimeMs===i.options.modifyTime){const{birthTime:t,modifyTime:e,firstCommitTime:n,lastCommitTime:o}=i.options;return{birthTime:t,modifyTime:e,firstCommitTime:n,lastCommitTime:o}}}const{birthtimeMs:n,mtimeMs:o}=await m(t);return new Promise((async i=>{if(e)return void i({birthTime:n,modifyTime:o});let s=[];const r=d("git",["--no-pager","log",'--pretty="%ci"',t]);r.stdout.on("data",(t=>{const e=String(t).split("\n").map((t=>+new Date(t))).filter((t=>t));s.push(...e)})),r.on("close",(async()=>{s.length?i({lastCommitTime:+new Date(s[s.length-1]),firstCommitTime:+new Date(s[0]),birthTime:n,modifyTime:o}):i({birthTime:n,modifyTime:o})})),r.on("error",(async()=>{i({birthTime:n,modifyTime:o})}))}))}function h(t){o(t,new Date,new Date)}function u(t,e,i,n=""){const o=`${n}${i}`;return t[o]??e[o]}function g(t){let e,i;for(const n of t)if(n.isFolder){const t=g(n.children);e=Math.min(e??1/0,t.minFirstCommitTime??1/0),i=Math.max(i??0,t.maxLastCommitTime??0)}else e=Math.min(e??1/0,n.options.firstCommitTime??1/0),i=Math.max(i??0,n.options.lastCommitTime??0);return{minFirstCommitTime:e===1/0?void 0:e,maxLastCommitTime:0===i?void 0:i}}function T(t){for(const e of t)if(e.isFolder){T(e.children);const t=g(e.children);e.options.firstCommitTime=t.minFirstCommitTime,e.options.lastCommitTime=t.maxLastCommitTime}}function v(t,e=y,i=""){return t.map(((t,n)=>(t.index=n,t.children&&t.children.length>0&&(t.children=v(t.children,e,i)),t))).sort(((t,n)=>e(t,n,i)))}function y(t,e,i=""){const n=u(t.frontmatter,t.options,"sort",i),o=u(e.frontmatter,e.options,"sort",i),s=t.options.firstCommitTime||t.options.birthTime,r=e.options.firstCommitTime||e.options.birthTime;return void 0!==n&&void 0!==o?n-o||s-r:void 0!==n&&void 0===o?n===e.index?-1:n-e.index:void 0===n&&void 0!==o?o===t.index?1:t.index-o:s-r}function b(t,e=""){return e+=`/${t.name}`,t.children.length>0?b(t.children[0],e):e.replace(".md","")}async function x(t){const e=C[t];if(e){if((await m(t)).mtimeMs===e.options.modifyTime)return e.frontmatter}const i=await r(t,{encoding:"utf-8"}),{content:n,data:o}=f(i);return o.h1=w(n,o),o}function w(t,e){let i=t.match(/^\s*#\s+(.*)[\n\r][\s\S]*/)?.[1];if(i){const t=/\{\{\s*\$frontmatter\.(\S+?)\s*\}\}/g;let n;for(;null!==(n=t.exec(i));){const t=new RegExp("\\{\\{\\s*\\$frontmatter\\."+n[1]+"\\s*\\}\\}","g");i=i.replace(t,e[n[1]])}}return i}let C={};const M=new Set;function $(o={}){return{name:"vite-plugin-vitepress-auto-nav",async configureServer({config:e,watcher:i}){const{vitepress:{configPath:n}}=e,s=n?.match(/(\.vitepress.*)/)?.[1]||".vitepress/config.ts",r=function(t,e){let i,n=0;return function(...o){const s=Date.now(),r=s-n;r>=e?(t.apply(this,o),n=s):(clearTimeout(i),i=setTimeout((()=>{t.apply(this,o),n=Date.now()}),e-r))}}(k.bind(null,s),1500);i.on("all",((e,i)=>{o.summary?.target&&t(i)===t(o.summary.target)?h(s):r(e,i)}))},async config(f){const{vitepress:{userConfig:{srcExclude:d=[],srcDir:h="./"},site:{themeConfig:{nav:g}},cacheDir:y}}=f;if(o.summary){console.log("🎈 SUMMARY 解析中...");const{sidebar:e,nav:i}=await async function(e){const{target:i,collapsed:n,removeEscape:o=!0}=e,s=(await r(t(i),{encoding:"utf-8"})).split(/\r?\n/).filter((t=>t.trim())),m=[],a=[],c=[];let l;for(let t=0;t<s.length;t++){let e=c[c.length-1];const i=s[t],r=i.trim();if(r.startsWith("#")){let[t,s,r]=/^\s*(#+)\s+(.+?)\s*$/.exec(i)||[];if(!s||!r)continue;r=o?r.replace(/\\/g,""):r;const l=-s.length,f={text:r,items:[],collapsed:n};if(-1===l)m.push(f),c.push({depth:l,sidebarItem:f}),a.push({text:r,link:""});else{for(;e&&(e.depth>=0||e.depth<=l);)c.pop(),e=c[c.length-1];e?.sidebarItem&&(e.sidebarItem.items?.push(f),c.push({depth:l,sidebarItem:f}))}}else if(r.startsWith("*")||r.startsWith("-")){let[t,s,r,m]=/^(\s*)[\*\-]\s+\[(.+)\]\((.+).md\)\s*$/.exec(i)||[];if(!m)continue;m.startsWith("/")||(m=`/${m}`),r=o?r.replace(/\\/g,""):r;const f={text:r,link:m,items:[],collapsed:n};void 0===l&&s&&(l=s);const d=s?s.length/l.length:0;for(;e&&e.depth>=d;)c.pop(),e=c[c.length-1];e?.sidebarItem&&(e.sidebarItem.items?.push(f),c.push({depth:d,sidebarItem:f}),a.length&&!a[a.length-1].link&&(a[a.length-1].link=m))}}return{sidebar:m,nav:a}}(o.summary);return f.vitepress.site.themeConfig.sidebar=e,g||(f.vitepress.site.themeConfig.nav=i),console.log("🎈 SUMMARY 解析完成..."),f}console.log("🎈 auto-nav 生成中..."),M.clear(),s(y)||await a(y);try{const t=await r(`${y}/auto-nav-cache.json`,{encoding:"utf-8"});C=JSON.parse(t)||{}}catch(t){}const w=o.pattern||"**.md",$=(await l(w,{cwd:h,ignore:["**/node_modules/**","**/dist/**","index.md",...d]})).map((e=>t(e)));let k=await async function(o,{itemsSetting:s={},useArticleTitle:r,frontmatterPrefix:a},c){const l={};for(const e in s)l[t(e)]=s[e];const f=Object.keys(l),d=[];for(const t of o){let o=d,s="";const h=t.split(e);for(const t of h){s=i(s,t);const e=n(c,s),d=(await m(e)).isDirectory();let h={useArticleTitle:r},g=f.find((t=>s===t));if(null==g&&(g=f.find((e=>t===e||t.replace(".md","")===e))),null!=g){const{collapsed:t,hide:e,sort:i,title:n,useArticleTitle:o}=l[g];h={collapsed:t,hide:e,sort:i,title:n,useArticleTitle:o??h.useArticleTitle}}const T=await p(e,d);h={...h,...T};let v={};if(d||(v=await x(e)),C[e]={options:h,frontmatter:v},M.add(e),u(v,h,"hide",a))break;let y=o.find((e=>e.name===t));y||(y={index:0,name:t,isFolder:d,options:h,frontmatter:v,children:[]},o.push(y)),o=y.children}}return d}($,o,h);T(k),k=v(k,o.compareFn),g||(f.vitepress.site.themeConfig.nav=k.map((t=>({text:t.options.title||t.name,activeMatch:`/${t.name}/`,link:b(t)}))));const D=function(t,e){const{indexAsFolderLink:i=!0,frontmatterPrefix:n=""}=e,o={};for(const{name:e,children:i}of t)o[`/${e}/`]=s(i,`/${e}`).sidebarMulti;function s(t,e){let o;return{sidebarMulti:t.reduce(((t,r)=>{const m="index"===r.name.replace(".md",""),a=m?`${e}/`:`${e}/${r.name}`;if(i&&m)return o=a,t;const c=u(r.frontmatter,r.options,"title",n)||u(r.frontmatter,r.options,"useArticleTitle",n)&&r.frontmatter.h1||r.name.replace(".md","");if(r.isFolder){const e=s(r.children,a);t.push({text:c,collapsed:r.options.collapsed??!1,items:e.sidebarMulti,link:e.link})}else t.push({text:c,link:a.replace(".md","")});return t}),[]),link:o}}return o}(k,o);f.vitepress.site.themeConfig.sidebar=D;for(let t in C)M.has(t)||delete C[t];return c(`${y}/auto-nav-cache.json`,JSON.stringify(C)),console.log("🎈 auto-nav 生成完成"),f}}}async function k(t,e,i){if(i.endsWith(".md"))if("change"===e&&C[i]){const e=await r(i,{encoding:"utf-8"}),{content:n,data:o}=f(e);if(o.h1=w(n,o),Object.keys(o).length!==Object.keys(C[i].frontmatter).length)return void h(t);for(let e in o)if(C[i].frontmatter[e]!==o[e])return void h(t)}else h(t)}export{C as cache,$ as default,M as visitedCache};
